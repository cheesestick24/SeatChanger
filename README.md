# Seat Changer

Seat Changer は、クラスの席替えを行うための Web アプリケーションです。ユーザーはクラスの人数、席数、隣に座らせたくないペア、固定席を設定し、席替えを実行できます。また、席替え結果を画像として生成することもできます。

## セットアップ

### 必要条件

- Node.js (バージョン 14 以上)
- npm (Node.js に含まれています)

### インストール

1. リポジトリをクローンします。

   ```bash
   git clone https://github.com/yourusername/seat-changer.git
   cd seat-changer
   ```

2. 依存関係をインストールします。

   ```bash
   npm install
   ```

3. 環境変数を設定します。`.env`ファイルを作成し、以下の内容を追加します。

   ```plaintext
   PORT=3000
   ```

### 実行

開発サーバーを起動します。

```bash
npm start
```

ブラウザで以下の URL にアクセスします。

```url
http://localhost:3000
```

### テスト

テストを実行します。

```bash
npm test
```

## 使用方法

1. クラスの人数、縦の席数、横の席数を入力します。
2. 隣に座らせたくない生徒のペアを追加します。
3. 固定席を追加します。
4. 「席替えを実行」ボタンをクリックして、席替えを実行します。
5. 席替え結果が表示されます。
6. 「画像を生成」ボタンをクリックして、席替え結果を画像として生成します。

## このアプリについて

今回は、友人が学校の先生をしていて困っていたので
Node.js、Express、Bootstrap、CDN版Vue、Canvasを使って席替えアプリを作成しました。
以下にその詳細を紹介します。

## 使用技術

- **Node.js**: サーバーサイドのJavaScriptランタイム
- **Express**: Node.jsのための軽量なWebアプリケーションフレームワーク
- **Bootstrap**: モバイルファーストなフロントエンドフレームワーク
- **Vue**: フロントエンドのJavaScriptフレームワーク
- **Canvas**: HTML5の描画API
- **Azure Web Apps**: アプリケーションのデプロイとホスティングを行うためのクラウドサービス

## プロジェクト構成

プロジェクトのディレクトリ構成は以下の通りです。

```tree
SeatChanger/
│  .gitignore
│  api.mjs
│  package-lock.json
│  package.json
│  README.md
│  server.mjs
├─public
│  │  index.html
│  ├─css
│  │      style.css
│  ├─fonts
│  │      NotoSansJP-VariableFont_wght.ttf
│  ├─img
│  │      icns.ico
│  │      icns.png
│  └─js
│          app.js
└─__tests__
        generate-image.test.js
        shuffle.test.js
```

## サーバーサイドの実装

`server.mjs`では、Expressを使ってサーバーを立ち上げています。また、環境変数を読み込むために`dotenv`を使用しています。
このアプリケーションはAzure Web Apps上で運用されています。

### mjsについて

`mjs`は、JavaScriptモジュールファイルの拡張子です。`mjs`ファイルは、ES6モジュールを使用するために特別に設計されています。Node.jsでは、`mjs`拡張子を持つファイルは自動的にESモジュールとして扱われます。これにより、`import`や`export`を使用してモジュールを管理することができます。

#### メリット

- **標準化**: ES6モジュールはJavaScriptの標準仕様であり、ブラウザや他のJavaScript環境でもサポートされています
- **スコープの分離**: モジュールごとにスコープが分離されるため、変数の衝突を避けることができます。
- **ツールのサポート**: 多くのモダンなツールやライブラリがES6モジュールをサポートしています。

#### デメリット

- **互換性**: 古いバージョンのNode.jsやブラウザではサポートされていない場合があります。
- **設定の必要性**: プロジェクトによっては、`mjs`ファイルを使用するために追加の設定が必要になることがあります
- **パフォーマンス**: 一部のケースでは、`require`を使用したCommonJSモジュールよりもパフォーマンスが劣ることがあります

## フロントエンドの実装

`public/js/app.js`では、Vueを使って席替えのロジックを実装しています。席替えの結果を表示するためにCanvasを使用しています。

## HTMLとCSSの実装

`public/index.html`では、Bootstrapを使ってスタイルを整えています。Bootstrapを使うことでモバイルでも利用しやすい状態になっています。
また、`public/css/style.css`では、カスタムスタイルを追加しています。

## APIの実装

`api.mjs`では、席替えのロジックと座席表の画像生成を行うAPIを実装しています。

### 画像生成について

当初はHTMLのテーブルを使用して座席表を実装していましたが、利便性や学習のために画像生成を行うことにしました。最初は`html2canvas`ライブラリを使用してクライアント側で処理を行っていましたが、環境依存の問題が発生し、特にスマートフォンで不具合が生じました。

そこで、サーバー側で処理を行う方法を模索し、`puppeteer`というライブラリにたどり着きました。しかし、`puppeteer`を使用した実装はうまくいきませんでした。代替案を探している中で、`node-html-to-image`というライブラリを見つけました。これは内部で`puppeteer`を使用しており、簡単に画像生成ができるものでした。ローカル環境ではうまく動作しましたが、Azureにデプロイする際にGitHub Actionsでエラーが発生しました。これはChromiumの不具合が原因のようでした。

画像をダウンロードできるようにすることも考えましたが、日本ではiPhoneの利用者が多く、iPhoneでは画像をダウンロードする際に`フォルダ`アプリを一度挟んで`写真`アプリに保存する必要があります。このひと手間を無くすために、画像生成して表示させることにしました。

最終的に、`canvas`ライブラリを使用することで問題を解決し、無事に実装とデプロイを完了することができました。

## テストの実装

このプロジェクトでは、ユニットテストを実装して機能の正確性を確認しています。テストは`__tests__`ディレクトリに配置されています。

### テストの構成

- **generate-image.test.js**: 座席表の画像生成機能のテストを行います
- **shuffle.test.js**: 席替えのシャッフルロジックのテストを行います

### テストの実行方法

以下のコマンドを使用してテストを実行できます。

```bash
npm test
```

[アプリリンク](https://app-seat-changer-bxh0aadceccqe7fc.japanwest-01.azurewebsites.net/)

## ライセンス

このプロジェクトは、[ISC ライセンス](LICENSE)の下でライセンスされています。
